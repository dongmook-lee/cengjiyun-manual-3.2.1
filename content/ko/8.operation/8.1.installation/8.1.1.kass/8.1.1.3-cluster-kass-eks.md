---
title: "8.1.1.3 EKS 클러스터 만들기"
---

---
### [8.1.1.3 EKS 클러스터 만들기 Quick Start](../8.1.1.5-cluster-kass-eks-quick-start)

---
## EKS 클러스터를 배포하는 방법.
Kubernetes 용 Amazon Elastic Container Service (Amazon EKS)를 사용하면 AWS의 Kubernetes를 사용하여 컨테이너 화 된 응용 프로그램을 쉽게 배포, 관리 및 확장 할 수 있다.

**참조 : [Amazon Elastic Container Service for Kubernetes(EKS) 클러스터 배포](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/what-is-eks.html)**

---
### Amazon Eks에 로그인

  * [Amazon Eks](https://aws.amazon.com/eks/)에 로그인.

---
### Amazon EKS 필수 조건

  * Amazon EKS 클러스터를 생성하기 전에 Kubernetes가 AWS 리소스 생성 시 수임할 수 있는 IAM 역할을 생성해야 한다. 

  * AWS 관리자 권한이 없다면 필요한 역할 / 정책 / 권한 을 요청 해야 한다.  
    참조 : [EKS 관리 권한 / 정책](../8.1.1.4)

<!--

### 1. 사용자 권한 / 정책
사용자가 클러스터를 생성 / 관리할 수 있는 권한 / 정책이 필요 한다.

  * **CloudFormation** - 전체: 목록, 쓰기 제한: 읽기 / 이에 사용되는 리소스 권한이 있어야 한다.  
  AWS CloudFormation은 개발자와 시스템 관리자에게 관련 AWS 리소스 모음을 손쉽게 생성 및 관리하고 순서 있고 예측 가능한 방식으로 프로비저닝하고 업데이트 할 수있는 방법을 제공한다.

  * **EC2** -  AmazonEC2FullAccess 권한이 있어야 한다.  
  Amazon Elastic Compute Cloud (Amazon EC2)는 클라우드에서 안전하고 크기 조정이 가능한 컴퓨팅 용량을 제공하는 웹 서비스입니다.

  * **EKS** - 모든 액세스 / 모든 리소스 권한이 있어야 한다.  
  Amazon Elastic Container Service for Kubernetes (EKS)는 자체 Kubernetes control plane을 설치, 작동 및 유지할 필요없이 Kubernetes를 AWS에서 쉽게 실행할 수 있도록 관리되는 Kubernetes 서비스입니다.

  * **IAM** - 목록, 읽기, 쓰기, 권한 관리 / 이에 사용되는 리소스 권한이 있어야 한다.  
  AWS Identity and Access Management (IAM)를 사용하면 AWS 서비스 및 리소스에 대한 액세스를 안전하게 관리한다.

  * **SNS** - 목록 / 모든 리소스 권한이 있어야 한다.  
  Amazon Simple Notification Service(SNS)는 마이크로서비스, 분산 시스템 및 서버리스 애플리케이션을 쉽게 분리할 수 있게 해 주는 내구적이고 안전한 고가용성의 완전 관리형 게시/구독 메시징 서비스입니다

  * **VPC** - AWS Management Console을 통해 Amazon VPC에 대한 완벽한 액세스를 제공한다.  
  Amazon Virtual Private Cloud(Amazon VPC)에서는 사용자가 정의한 가상 네트워크로 AWS 리소스를 시작할 수 있다.

### 2. 사용자 권한 / 정책 만들기

  * [IAM(Identity and Access Management)](https://console.aws.amazon.com/iam) 에서 정책(Policies)을 선택한다.  

    * 정책 생성(Create policy) / 기존의 정책 편집(Edit policy)을 선택한다.

      * 권한 추가(Add additional permissions)를 선택한다.  

        * 서비스 항목에서 필요한 서비스를 검색 / 선택한다.

        * **CloudFormation** - 목록 에서 액세스 레벨 / 리소스 에서 필요한 권한을 선택한다.  
          AWS CloudFormation은 Amazon Web Services 리소스를 모델링하고 설정하는 데 도움이되는 서비스로, 리소스 관리 시간을 줄이고 AWS에서 실행되는 애플리케이션에 집중할 수 있다.  
          원하는 모든 AWS 리소스 (예 : Amazon EC2 인스턴스 또는 Amazon RDS DB 인스턴스)를 설명하는 템플릿을 만들고 AWS CloudFormation은 이러한 리소스를 프로비저닝하고 구성하는 작업을 담당한다.  
          AWS 리소스를 개별적으로 생성하고 구성 할 필요가 없으며 무엇에 의존하는지 파악할 수 있다. [Learn more](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/)  

            ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-policies-CloudFormation-1.png)
            ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-policies-CloudFormation-2.png)
            ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-policies-CloudFormation-3.png)

        * **EKS** - 목록 에서 액세스 레벨 / 리소스 에서 필요한 권한을 선택한다.  
          Kubernetes 용 Amazon Elastic Container Service (Amazon EKS)는 자체 Kubernetes control plane을 세우거나 유지할 필요없이 AWS에서 Kubernetes를 쉽게 실행할 수 있도록 해주는 관리 형 서비스입니다.  

            ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-policies-EKS-1.png)

        * **IAM** - 목록 에서 액세스 레벨 / 리소스 에서 필요한 권한을 선택한다.  
          AWS ID 및 액세스 관리 (IAM)는 AWS 리소스에 대한 액세스를 안전하게 제어 할 수있는 웹 서비스입니다.  
          IAM을 사용하여 자원을 사용하도록 인증 (로그인)되고 권한이 부여 된 (사용 권한이있는) 사용자를 제어한다.  

            ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-policies-IAM-1.png)

        * **SNS** - 목록 에서 액세스 레벨 / 리소스 에서 필요한 권한을 선택한다.  
          Amazon SNS (Amazon Simple Notification Service)는 가입 엔드 포인트 또는 클라이언트로 메시지를 전달하거나 메시지 서비스를 조정 및 관리하는 웹 서비스입니다.  
          게시자는 논리 액세스 포인트 및 통신 채널 인 주제에 메시지를 생성하고 전송하여 구독자와 비동기 적으로 통신한다.  

            ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-policies-SNS-1.png)

    * 정책 검토(Review policy)를 선택한다.

        * 이름(Name) :  
        AmazonEKSAdminPolicy와 같은 사용자 정책 이름을 입력 한다.

        * 설명(Description) :  
        사용자 정책의 설명을 입력 한다.  
    
    * 정책 생성을 선택한다.

* [IAM(Identity and Access Management)](https://console.aws.amazon.com/iam) 에서 사용자(Users)를 선택한다.  

    * 생성한 또는 편집한 정책을 사용자에게 추가 한다.

        * 권한 추가(Add permission)를 선택한다.

        * 기존 정책 직접 연결(Attach existing policies directly )을 선택한다.

            * 생성 및 편집 한 정책을 검색 해서 사용자에게 권한 추가 한다.

            * 이 사용 설명서 에서는 다음 과 같은 정책으로 사용 하였습니다.

                * **AmazonEKSAdminPolicy** :  
                    CloudFormation, EKS, IAM, SNS

                * **AmazonVPCFullAccess** :  
                    Provides full access to Amazon VPC via the AWS Management Console.  
                    Amazon EC2를 사용하여 필요한만큼 가상 서버를 시작하고 보안 및 네트워킹을 구성하며 스토리지를 관리 할 수 있다.  

                * **AmazonEC2FullAccess** :  
                    Provides full access to Amazon EC2 via the AWS Management Console.  
                    Amazon Elastic Compute Cloud (Amazon EC2)는 Amazon Web Services (AWS) 클라우드에서 확장 가능한 컴퓨팅 용량을 제공한다.  
                    Amazon EC2를 사용하여 필요한만큼 가상 서버를 시작하고 보안 및 네트워킹을 구성하며 스토리지를 관리 할 수 있다.  


    이 사용 설명서에서는 아래와 같이 권한을 사용한다.
    ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-user-policies-1.png)

-->
    
---
### AWS EKS 클러스터 만들기
Kubernetes 용 Amazon Elastic Container Service (Amazon EKS)는 AWS에서 Kubernetes를 쉽게 실행할 수 있도록 해주는 관리 형 서비스입니다.  

---
### 1. AWS 리소스 생성 시 수임할 수 있는 IAM 역할을 생성 한다.
**관리자 권한 또는 해당 IAM 권한이 필요 한다.**

  * **[Roles(역할)]**를 선택한 다음 **[Create role]**을 선택한다.

    * 서비스 목록에서 EKS를 선택한다.  

    * 사용 사례에 대해 Allows Amazon EKS to manage your clusters on your behalf(EKS에서 사용자를 대신하여 클러스터를 관리하도록 허용)를 선택한다.
    
  * **[Next: Permissions(다음: 권한)]**를 선택한다.  
    
    * **AmazonEKSClusterPolicy** :  
      이 정책은 Kubernetes에게 사용자를 대신하여 리소스를 관리하는 데 필요한 권한을 제공한다.  
      Kubernetes는 인스턴스, 보안 그룹 및 탄력적인 네트워크 인터페이스를 포함하되 이에 국한되지 않는 EC2 리소스에 대한 식별 정보를 배치하는 데 Ec2 : CreateTags 권한이 필요.  

    * **AmazonEKSServicePolicy** :  
      이 정책에 따라 Kubernetes 용 Amazon Elastic Container Service는 EKS 클러스터를 운영하는 데 필요한 리소스를 만들고 관리 할 수 있다.  

  * **[Next: Tags(다음: 태그)]**를 선택한다.  
    IAM 태그는 사용자 역할에 추가할 수 있는 키-값 이다.  
    태그는 이메일 주소와 같은 사용자 정보를 포함하거나 직책과 같은 내용일 수 있다. 태그를 사용하여 이 역할에 대한 액세스를 구성, 추적 또는 제어할 수 있다. [Learn more](http://docs.aws.amazon.com/console/iam/roles-tagging)  

  * **[Next: Review(다음: 검토)]**를 선택한다.  
    생성하기 전에 아래에 필요한 정보를 입력하고 이 역할을 검토하십시오.  

    * Role name(역할 이름)에서 역할에 대한 고유 이름(예: eksServiceRole)을 입력한다.  
        
  * **Create role(역할 생성 만들기)**을 선택한다.

  * 만들어진 역할을 확인 한다.

    * **[Roles(역할)]**를 선택 :  
      목록에서 새로 생성한 Role(역할)을 확인할 수 있다.

  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-role-1.png)
  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-role-2.png)
  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-role-3.png)
  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-role-4.png) 


<!-- ### 2. Amazon EKS 클러스터 VPC 생성 - 직접 생성(권장)
이 사용 설명서에서는 직접 생성을 선택 한다.  

  * 상단 서비스(Services)를 선택 VPC Service를 선택한다.

  * 상단 리전 모음에서 Amazon EKS를 지원하는 리전을 선택한다.  
    이 사용 설명서에서는 서울 리전을 사용한다.

  * VPC 만들기(Launch VPC Wizard)를 선택한다.
    
    * 1단계: VPC 구성 선택(Step 1: Select a VPC Configuration) :  
      이 사용 설명서에서는 단일 퍼블릭 서브넷을 선택한다.

      * 단일 퍼블릭 서브넷이 있는 VPC :  
        고객의 인스턴스는 AWS 클라우드의 프라이빗 격리 섹션에서 실행되며 인터넷에 직접 액세스한다.  
        네트워크 액세스 제어 목록 및 보안 그룹을 사용하여 인스턴스를 드나드는 인바운드 및 아웃바운드 네트워크 트래픽을 엄격히 제어할 수 있다.  

      * 퍼블릭 및 프라이빗 서브넷이 있는 VPC :  
        이 구성은 퍼블릿 서브넷을 포함하는 이외에 인터넷에서 인스턴스의 주소를 지정할 수 없는 프라이빗 서브넷을 추가한다.  
        프라이빗 서브넷의 인스턴스는 NAT(Network Address Translation)를 사용하는 퍼블릭 서브넷을 통해 인터넷과 아웃바운드 연결을 설정할 수 있다.  

      * 퍼블릭 및 프라이빗 서브넷이 있고 하드웨어 VPN 액세스를 제공하는 VPC :  
        이 구성은 Amazon VPC와 데이터 센터 사이에 IPsec 가상 프라이빗 네트워크(VPN) 연결을 추가하여 데이터 센터를 효과적으로 클라우드까지 확장하는 한편 Amazon VPC의 퍼블릭 서브넷 인스턴스에게 직접 인터넷 액세스를 제공한다.  

      * 프라이빗 서브넷만 있고 하드웨어 VPN 액세스를 제공하는 VPC :  
        고객의 인스턴스가 AWS 클라우드의 프라이빗 격리 섹션에서 실행되고 인터넷에서 인스턴스의 주소를 지정할 수 없는 프라이빗 서브넷이 포함됩니다.  
        이 프라이빗 서브넷을 IPsec 가상 프라이빗 네트워크(VPN) 터널을 통해 기업 데이터 센터에 연결할 수 있다.  

    ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-vpc-1.png)

    * 2단계: 단일 퍼블릭 서브넷이 있는 VPC

      * IPv4 CIDR 블록(필수항목) : (65531 IP 주소 사용 가능)  
        이 사용 설명서에서는 기본 값을 사용한다. - 10.0.0.0/16

      * IPv6 CIDR 블록 :  
        이 사용 설명서에서는 기본 값을 사용한다. - Pv6 CIDR 블록 없음
      
      * VPC 이름 :  
        VPC에 고유 이름을 부여한다  
        이 사용 설명서에서는 cocktail-eks-test-vpc 글 사용한다.

      * 퍼블릭 서브넷의 IPv4 CIDR(필수항목) : (251 IP 주소 사용 가능)  
        이 사용 설명서에서는 기본 값을 사용한다. - 10.0.0.0/24

      * 가용 영역(Availability Zone)(필수항목) :  
        리전에서 사용 되는 가용 영역을 선택한다.  
        이 사용 설명서에서는 ap-northeast-2a, ap-northeast-2c를 사용한다.  
      
      * 서브넷 이름(Subnet name) :  
        AWS가 VPC를 생성한 후 더 많은 서브넷을 추가할 수 있다.  
        이 사용 설명서에서는 cocktail-test-subnet-01, cocktail-test-subnet-02 2개를 사용한다.  
        Subnet 추가 섹션을 참조 하세요. 참조 : [클러스터 VPC 고려 사항](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/network_reqs.html)  

      * 서비스 엔드포인트(Service endpoints) :  
        이 사용 설명서에서는 기본 값을 사용한다.  

      * DNS 호스트 이름 활성화 :  
        이 사용 설명서에서는 기본 값을 사용한다. - 예(Yes)

      * 하드웨어 테넌시 :  
        이 사용 설명서에서는 기본 값을 사용한다. - 기본값(Default)
    
    * 하단 VPC 만들기를 선택한다.

    * VPC 생성되면 확인을 선택한다.

  * Your VPCs 화면 목록에서 생성된 VPC를 확일 할 수 있다.

  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-vpc-2.png)
  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-vpc-3.png)  

### 2-1. 서브넷(Subnets) 만들기
Amazon EKS 클러스터를 생성할 때 클러스터가 사용할 Amazon VPC 서브넷을 지정한다.  
**Amazon EKS의 경우 2개 이상의 다른 가용 영역에서 서브넷이 필요.**  
내부에서 인터넷 경계 로드 밸런서를 생성하려면 작업자 노드에 대해 프라이빗 서브넷을 사용하고 Kubernetes에 대해 퍼블릭 서브넷을 사용하는 네트워크 아키텍처를 권장한다.  
클러스터를 만들 때 해당 클러스터를 위해 리소스를 호스팅할 모든 서브넷을 지정한다(예: 작업자 노드와 로드 밸런서).

  * VPC Service에서 서브넷(Subnets)를 선택한다.

    * 서브넷 생성(Create subnet)을 선택한다.

      * Name 태그(Name tag) :  
        'Name' 키와 사용자가 지정하는 값을 포함하는 태그를 생성 한다.  
        이 사용 설명서에서는 cocktail-test-subnet-01, cocktail-test-subnet-02를 사용한다.
      
      * VPC(필수항목) :  
        생성한 VPC를 선택한다.

      * 가용 영역(Availability Zone)(필수항목) :  
      이 서브넷이 위치할 가용 영역입니다. Amazon에서 가용 영역을 선택하도록 하려면 기본 설정 없음을 선택한다.  
      이 사용 설명서에서는 ap-northeast-2a, ap-northeast-2c를 선택한다.

      * IPv4 CIDR 블록(필수항목) :  
        서브넷에 대한 IP 주소의 범위를 나타내는 CIDR블록(예: 10.0.1.0/24).  
        블록 크기는 /16 ~ /28 넷마스크여야 하며, VPC의 서브넷이거나 동일한 크기일 수 있다.  
        이 사용 설명서에서는 10.0.1.0/24, 10.0.2.0/24를 사용한다.
    
    * 생성(Create)을 선택한다.

    * 정상 생성 되면 닫기를 선택 한다.

  * VPC Service 의 서브넷(Subnets) 화면에서 확인할 수 있다.

  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-subnet-1.png)
  ![eks-in-seoul]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-subnet-2.png)

### 2-2. 보안 그룹(Security Groups) 만들기
보안 그룹은 인바운드 및 아웃 바운드 트래픽을 제어하기위한 인스턴스의 가상 방화벽 역할을한다.

* AWS VPC service 화면에서 보안 그룹을 선택한다.

    * Create security group를 선택한다.  


        * Security group name :  
        이 사용 설명서에서는 cocktail-eks-test-security-group를 사용한다.

        * Description :  
        간략한 설명을 입력 한다.

        * VPC :  
        보안그룹을 사용 할 VPC를 선택 한다.
    
    * Create를 선택한다.

    ![eks-create-security-group-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-security-group-1.png)
 -->

---
### 2. Amazon EKS 클러스터 VPC 생성 - CloudFormation 콘솔 사용해서 생성
참조 : AWS [사용 설명서](https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html)를 참조.  

* <https://console.aws.amazon.com/cloudformation>에서 AWS CloudFormation 콘솔에서 제공 되는 템플릿을 사용해서 생성.

* 상단 리전 모음에서 Amazon EKS를 지원하는 리전을 선택.  

    **참고**  
    현재 다음 리전에서 Amazon EKS를 사용할 수 있다. (한국어 사용 설명서는 아직 반영이 안되어 있다.)  

    * **US West (Oregon)** (us-west-2)

    * **US East (N. Virginia)** (us-east-1)

    * **US East (Ohio)** (us-east-2)

    * **EU (Frankfurt)** (eu-central-1)

    * **EU (Stockholm)** (eu-north-1)

    * **EU (Ireland)** (eu-west-1)

    * **Asia Pacific (Tokyo)** (ap-northeast-1)

    * **Asia Pacific (Seoul)** (ap-northeast-2)

    * **Asia Pacific (Singapore)** (ap-southeast-1)

    * **Asia Pacific (Sydney)** (ap-southeast-2)

* [Create stack]을 선택.  

* 템플릿 선택에서 Amazon S3 템플릿 URL 지정을 선택.  

    ```yaml
    https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2019-02-11/amazon-eks-vpc-sample.yaml

    ```
    
    **주의 :** 2019-01-09 이전 날짜의 템플릿파일을 서울리전에서 사용시 오류가 있다. (AZ가 없는 관계로)

    * 스택 이름: AWS CloudFormation 스택에 대한 스택 이름을 선택한다. 예를 들어 eks-vpc로 사용할 수 있다.

    * VpcBlock: VPC에 대한 CIDR 범위를 선택한다. 기본값을 유지할 수 있다.

    * Subnet01Block: 서브넷 1에 대한 CIDR 범위를 선택한다. 기본값을 유지할 수 있다.

    * Subnet02Block: 서브넷 2에 대한 CIDR 범위를 선택한다. 기본값을 유지할 수 있다.

    * Subnet03Block: 서브넷 3에 대한 CIDR 범위를 선택한다. 기본값을 유지할 수 있다.

* (선택 사항) 옵션 페이지에서 스택 리소스에 태그를 지정한다. **[Next]**를 선택.

* [Review] 페이지에서 **[Create]**을 선택한다.

* 스택이 생성된 후 콘솔에서 이를 선택하고 **출력**을 선택한다.

* 생성된 보안 그룹에 대한 **SecurityGroups** 값을 기록한다. 이 값은 EKS 클러스터를 생성할 때 필요. 이 보안 그룹은 서브넷에 생성된 계정 간 탄력적 네트워크 인터페이스에 적용되고, 이를 통해 Amazon EKS 제어 플레인이 작업자 노드와 통신할 수 있다.

* 생성된 VPC의 **VpcId를** 기록한다. 작업자 노드 그룹 템플릿을 시작할 때 필요.

* 생성된 서브넷에 대한 **SubnetIds를** 기록한다. EKS 클러스터를 생성할 때 필요. 작업자 노드가 시작되는 서브넷입니다.

![eks-create-cloudformation-vpc-1-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-cloudformation-vpc-1-1.png)
![eks-create-cloudformation-vpc-2-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-cloudformation-vpc-2-1.png)

---
### 3. Amazon EKS에 대한 kubectl을 설치한다.

Amazon EKS는 IAM을 사용하여 [Kubernetes용 AWS IAM Authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator)를 통해 Kubernetes 클러스터에 인증을 제공한다.  
Kubernetes 버전 1.10부터 Kubernetes용 AWS IAM Authenticator를 설치하고 인증에 사용할 kubectl 구성 파일을 사용하여 Amazon EKS를 사용할 stock kubectl 클라이언트를 구성할 수 있다.  
참조 : <https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html>  
참조: kubectl 설치 : <https://kubernetes.io/docs/tasks/tools/install-kubectl/>

  * Kubernetes 용 AWS IAM Authenticator는 AWS에서 Kubernetes 설치 프로그램을 작성하는 경우 부트 스트랩 프로세스를 간소화 할 수 있다.

  * 새로 설치 한 클러스터에서 초기 admin 자격 증명을 어떻게 든 안전하게 훔쳐 낼 필요가 없습니다.

  * 대신 클러스터 구축시 전용 KubernetesAdmin 역할을 만들고 Authenticator를 설정하여 클러스터 관리자 로그인을 허용 할 수 있다.

---
### 3-1. Amazon EKS용 aws-iam-authenticator를 설치한다.
Kubernetes 클러스터에 인증하기 위해 AWS IAM 자격 증명을 사용하는 도구 입니다.
Kubernetes 용 AWS IAM Authenticator를 사용하면 Kubernetes 액세스에 대한 별도의 자격 증명을 관리하지 않아도됩니다.  

* **aws-iam-authenticator** 바이너리를 다운로드 및 설치한다.  
Amazon EKS는 사용할 수 있는 aws-iam-authenticator 바이너리를 판매한다.  
또는 go get 을 사용하여 GitHub의 [Kubernetes용 AWS IAM Authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator) 프로젝트에서 다른 운영 체제용 바이너리를 가져올 수 있다.

* **1.** aws-iam-authenticator 바이너리를 다운로드 및 설치하려면 다음과 같이 한다.

    * Amazon S3에서 aws-iam-authenticator 바이너리를 다운로드한다.

    * **Linux:** <https://amazon-eks.s3-us-west-2.amazonaws.com/1.12.7/2019-03-27/bin/linux/amd64/aws-iam-authenticator>

    * **MacOS:** <https://amazon-eks.s3-us-west-2.amazonaws.com/1.12.7/2019-03-27/bin/darwin/amd64/aws-iam-authenticator>

    * **Windows:** <https://amazon-eks.s3-us-west-2.amazonaws.com/1.12.7/2019-03-27/bin/windows/amd64/aws-iam-authenticator.exe>

        아래 명령을 사용하여 바이너리를 다운로드하고 플랫폼에 맞는 올바른 URL로 교체한다. 아래 예는 MacOS 클라이언트에 해당됩니다.

        ```sh
        curl -o aws-iam-authenticator https://amazon-eks.s3-us-west-2.amazonaws.com/1.12.7/2019-03-27/bin/darwin/amd64/aws-iam-authenticator
        ```

    * 바이너리에 실행 권한을 적용한다.

        ```sh
        chmod +x ./aws-iam-authenticator
        ```

    * 바이너리를 $PATH의 폴더에 복사한다. $HOME/bin/aws-iam-authenticator를 생성하고 $PATH가 $HOME/bin로 시작하는 것이 좋습니다.

        ```sh
        cp ./aws-iam-authenticator $HOME/bin/aws-iam-authenticator && export PATH=$HOME/bin:$PATH
        ```

    * PATH 환경 변수에 $HOME/bin을 추가한다.

        * MacOS의 Bash 셸의 경우:

            ```sh
            echo 'export PATH=$HOME/bin:$PATH' >> ~/.bash_profile
            ```
        
        * Linux의 Bash 셸의 경우:

            ```sh
            echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
            ```

    * aws-iam-authenticator 바이너리가 작동하는지 테스트한다.

        ```
        aws-iam-authenticator help
        ```

<!--
* **2.** 또는 go get을 사용하여 GitHub에서 aws-iam-authenticator 바이너리를 설치한다.

    * go가 이미 설치되지 않은 경우 운영 체제에 대해 Go 프로그래밍 언어를 설치한다. 자세한 내용은 Go 문서의 [Install the Go tools](https://golang.org/doc/install#install)를 참조.

    * go get을 사용하여 aws-iam-authenticator 바이너리를 설치한다.

        ```
        go get -u -v github.com/kubernetes-sigs/aws-iam-authenticator/cmd/aws-iam-authenticator
        ```
    
    * PATH 환경 변수에 $HOME/go/bin을 추가한다.

        * MacOS의 Bash 셸의 경우:

            ```
            export PATH=$HOME/go/bin:$PATH && echo 'export PATH=$HOME/go/bin:$PATH' >> ~/.bash_profile
            ```

        * Linux의 Bash 셸의 경우:

            ```
            export PATH=$HOME/go/bin:$PATH && echo 'export PATH=$HOME/go/bin:$PATH' >> ~/.bashrc
            ```

    * aws-iam-authenticator 바이너리가 작동하는지 테스트한다.

        ```
        aws-iam-authenticator help
        ```
-->

---
### 3-2. (선택 사항) 최신 AWS CLI 다운로드 및 설치 한다.
AWS CLI가 Amazon EKS 사용을 명시적으로 요구하지는 않지만, **update-kubeconfig** 명령을 사용하면 kubeconfig 생성 프로세스가 크게 간소화됩니다.  AWS CLI에서 Amazon EKS를 사용하려면 **1.16.18 버전 이상의** AWS CLI가 설치되어 있어야 한다.  
AWS CLI를 설치 또는 업그레이드하려면 AWS Command Line Interface 사용 설명서의 [AWS 명령줄 인터페이스](https://docs.aws.amazon.com/cli/latest/userguide/installing.html) 설치를 참조.  

* AWS CLI 버전은 다음 명령을 통해 확인할 수 있다.

    ```
    aws --version
    ```

---
### 4. 1단계: Amazon EKS 클러스터 생성
이제 Amazon EKS 클러스터를 생성할 수 있다.  
참조 : [Amazon EKS 클러스터 생성 사용 설명서](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-cluster.html)를 참고 한다.

* 사전 요구 사항은 다음과 같습니다.

    * Amazon EKS 클러스터의 요건을 충족하는 VPC 및 전용 보안 그룹을 생성했습니다.  
    자세한 내용은 [클러스터 VPC 고려 사항](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/network_reqs.html) 및 [클러스터 보안 그룹 고려 사항](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/sec-group-reqs.html) 단원을 참조

    * Amazon EKS 서비스 역할을 생성하여 클러스터에 적용했습니다. [Amazon EKS 서비스 IAM 역할](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/service_IAM_role.html) 가이드를 참조 하시기 바랍니다.

<!--
* **중요**

    Amazon EKS 클러스터가 생성될 때 클러스터를 생성하는 IAM 엔터티(사용자 또는 역할)가 Kubernetes RBAC 권한 부여 표에 관리자(system:master 권한이 있음)로 추가됩니다.  
    처음에는 해당 IAM 사용자만이 kubectl을 사용하여 Kubernetes API를 호출할 수 있다. 자세한 정보는 [클러스터의 사용자 또는 IAM 역할 관리](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/add-user-role.html) 단원을 참조. 또한 [Kubernetes용 AWS IAM Authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator)에서는 Go용 AWS SDK을 사용하여 Amazon EKS 클러스터에 대한 인증을 수행한다.  
    콘솔을 사용하여 클러스터를 생성하는 경우 클러스터에서 kubectl 명령을 실행할 때 동일한 **IAM 사용자 자격 증명이 AWS SDK 자격 증명 체인에 있어야 한다.**

    AWS CLI를 설치하고 구성하면 사용자에 대한 IAM 자격 증명을 구성할 수 있다. 이 자격 증명은 [Kubernetes용 AWS IAM Authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator)에 대해서도 유효한다. AWS CLI가 사용자에 대해 적절하게 구성된 경우 [Kubernetes용 AWS IAM Authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator)에서도 이 자격 증명을 찾을 수 있다. 자세한 정보는 AWS Command Line Interface 사용 설명서의 [**AWS CLI**](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html) 구성을 참조.
-->

* AWS EKS 콘솔을 사용하여 클러스터를 생성 한다.

    * **1.** Open the Amazon EKS console at https://console.aws.amazon.com/eks/home#/clusters.

    * **2.** [Create cluster]를 선택한다.
    
        * **참고**  
            IAM 사용자에게 관리 권한이 없는 경우 해당 사용자가 Amazon EKS API 작업을 호출하는 권한을 명시적으로 추가해야 한다.  
            자세한 내용은 [Amazon EKS IAM 정책 만들기](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/EKS_IAM_user_policies.html) 단원을 참조.

    * **3.** 클러스터 생성 페이지에서 다음 필드를 입력한 다음 생성을 선택한다.

        * Create cluster
            * Cluster name :  
                Amazon EKS 클러스터에 대해 고유한 이름입니다.
            
            * Kubernetes version :  
                클러스터에 대해 사용할 Kubernetes 버전. 기본적으로 최신 버전이 선택됩니다.

            * Role name :  
                [Amazon EKS 서비스 역할 생성](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/getting-started.html#role-create) 사용을 통해 생성한 IAM 역할을 선택한다.

        * Networking

            * VPC :  
                [Amazon EKS 클러스터 VPC 생성](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-public-private-vpc.html) 사용을 통해 생성한 VPC를 선택한다.  
                드롭다운 목록에서 VPC의 이름을 찾을 수 있다.

            * Subnets :  
                기본적으로 위 VPC에서 사용 가능한 서브넷이 사전 선택됩니다.
            
            * Security groups :  
                [Amazon EKS 클러스터 VPC 생성](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/getting-started.html#vpc-create) 사용을 통해 생성된 보안 그룹(SecurityGroups) 값을 선택 한다.

                * **중요**  
                작업자 노드 AWS CloudFormation 템플릿이 여기서 사용자가 지정하는 보안 그룹을 수정하므로 클러스터 제어 플레인에 대한 **전용 보안 그룹을 사용하는 것이 바람직한다.** 다른 리소스와 공유할 경우 이러한 리소스를 방해하거나 막을 수 있다.

        * 정보 입력이 완료 되면 생성(Create)을 선택한다.

    * **4.** Clusters 화면에서 새로 생성된 클러스터를 선택하고 클러스터 정보를 확인할 수 있다.

    * **5.** Status(상태) 필드는 클러스터 프로비저닝 프로세스가 완료될 때까지 CREATING(생성 중)으로 표시됩니다.  
        클러스터 프로비저닝이 완료될 때(보통 10분 이내) API server endpoint(API 서버 엔드포인트) 및 인증 기관 값을 기록한다. 이 값은 kubectl 구성에 사용됩니다.

        ![eks-create-cluster-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-cluster-1.png)
        ![eks-create-cluster-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-cluster-2.png)
        ![eks-create-cluster-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-cluster-2-1.png)
        ![eks-create-cluster-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-cluster-2-2.png)

    * **6.** 클러스터를 생성했으므로 이제 [Amazon EKS용 kubectl 구성](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/configure-kubectl.html) 및 [Amazon EKS에 대한 kubeconfig 생성](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html)의 절차를 따라 새 클러스터와의 통신을 활성화한다.

---
### 4-1. Amazon EKS용 kubectl 구성
AWS CLI로 kubeconfig를 생성하려면 [Amazon EKS에 대한 kubeconfig 생성](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html)을 참조 하세요.
    
* 기본 AWS 자격 증명 공급자 체인을 사용 하려면 :  
AWS IAM 권한이 있는 관리자에게 사용자 보안 자격 증명(액세스 키)을 요청 한다.

    * AWS 자격 증명 공급자 체인 만들기

        * AWS IAM service 콘솔에서 사용자(Users)를 선택한다.

        * 보안 자격 증명(Security credentials) 섹션 에서 액세스 키를 생성한다.

        ![eks-create-security-credentials]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-security-credentials-1.png)

        * ~/.aws/credentials 파일 안에 해당 키 값을 입력 한다.  
        - 윈도우 경우 사용자 디렉토리 안에 .aws\redentials 파일이 있다.

        ```
        [default]
        aws_access_key_id=
        aws_secret_access_key=
        ```

        * 또는 AWS CLI를 사용해서 클러스터를 생성한 계정의 IAM유저의 보안자격증명을 설정한다.

        ```
        # aws configure
        AWS Access Key ID [None]: AKIAIHE#########FELA
        AWS Secret Access Key [None]: uqm8MSDK######################Ddz29PcAz5
        Default region name [ap-northeast-2]:
        Default output format [None]:
        # aws sts get-caller-identity
        {
        “Account”: “4952894#####”,
        “UserId”: “AIDAJU5LO##########LQ”,
        “Arn”: “arn:aws:iam::4952894#####:user/[username]”
        }
        ```

* AWS CLI로 kubeconfig를 생성하려면 :  

    ```
    # aws eks --region region update-kubeconfig --name cluster_name
    Updated context arn:aws:eks:ap-northeast-2:235896307296:cluster/cocktail-test-eks-cluster in C:\Users\shapj\.kube\config
    # kubectl get svc
    NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE
    kubernetes ClusterIP 10.100.0.1 <none> 443/TCP 1m
    ```

---
### 5. 2단계: Amazon EKS Work node 시작 및 구성
Amazon EKS work node는 AWS 계정에서 실행되고, 클러스터 API 서버 엔드포인트를 통해 Cluster Control Plane에 연결한다.  
참조 : <https://docs.aws.amazon.com/eks/latest/userguide/clusters.html>

* **중요**  
Amazon EKS Work node는 표준 Amazon EC2 인스턴스이고, 일반 Amazon EC2 온디맨드 인스턴스 가격을 기반으로 비용이 청구됩니다.  
자세한 내용은 Amazon EC2 요금을 참조.

* 이 주제의 사전 요구 사항은 다음과 같습니다.

    * Amazon EKS 클러스터의 요건을 충족하는 VPC 및 보안 그룹을 생성했습니다.  

    * Amazon EKS 클러스터를 생성하고 위 VPC 및 보안 그룹에 사용한다고 지정했습니다.

    * 시작 이후 SSH를 사용하여 Work node에 연결하는 데 사용할 수 있는 Amazon EC2 SSH 키 페어가 생성되어 있어야 한다.  
    참조 : [Amazon EC2를 사용해 키 페어 만들기](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-key-pairs.html)

---
### 5-1. 템플릿을 사용해서 Work node를 시작하려면

* **클러스터 상태가 ACTIVE가 되기를 기다립니다.**   
※ 클러스터가 활성화되기 전에 Work node를 시작하면 Work node가 클러스터에 등록되지 않고 Work node를 다시 시작해야 한다.

* https://console.aws.amazon.com/cloudformation 에서 AWS CloudFormation 콘솔.

* Amazon EKS를 생성할 리전을 선택한다.  
이 사용 설명서에서는 서울 리전을 사용한다.
<!--
    **참고**  
    현재 다음 리전에서 Amazon EKS를 사용할 수 있다. (한국어 사용 설명서는 아직 반영이 안되어 있다.)  

    * **US West (Oregon)** (us-west-2)

    * **US East (N. Virginia)** (us-east-1)

    * **US East (Ohio)** (us-east-2)

    * **EU (Frankfurt)** (eu-central-1)

    * **EU (Stockholm)** (eu-north-1)

    * **EU (Ireland)** (eu-west-1)

    * **Asia Pacific (Tokyo)** (ap-northeast-1)

    * **Asia Pacific (Seoul)** (ap-northeast-2)

    * **Asia Pacific (Singapore)** (ap-southeast-1)

    * **Asia Pacific (Sydney)** (ap-southeast-2)
-->
* **[Create stack]**을 선택한다.

* 템플릿 선택에서 Amazon S3 템플릿 URL 지정을 선택한다.

* 텍스트 영역에 다음 URL을 붙여넣고 다음을 선택한다.

    ```
    https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2019-02-11/amazon-eks-nodegroup.yaml

    ```

* Specify Details(세부 정보 지정) 페이지에서 다음 파라미터를 입력하고 다음을 선택한다.

    * **스택 이름** :  
        AWS CloudFormation 스택에 대한 스택 이름을 선택한다. 예를 들어 <cluster-name>-worker-nodes로 사용할 수 있다.
    
    * **ClusterName** :  
        Amazon EKS 클러스터 생성 시 사용할 이름을 입력한다.  
        **중요** : 이 이름은 Amazon EKS 클러스터 이름과 정확하게 일치해야 한다. 그렇지 않은 경우 Work node가 조인할 수 없습니다.

    * **ClusterControlPlaneSecurityGroup** :  
        Amazon EKS 클러스터를 생성할 때 사용한 보안 그룹 또는 그룹을 입력한다. 이 AWS CloudFormation 템플릿은 지정된 클러스터 제어 플레인 보안 그룹의 트래픽을 허용하는 Work node 보안 그룹을 생성한다.

    * **NodeGroupName** :  
        노드 그룹의 이름을 입력한다. 이 이름은 나중에 Work node에 대해 생성된 Auto Scaling 노드 그룹을 식별하는 데 사용할 수 있다.

    * **NodeAutoScalingGroupMinSize** :  
        Auto Scaling 그룹이 축소할 수 있는 Work node의 최소 노드 수를 입력한다.
        
    * **NodeAutoScalingGroupDesiredCapacity** : 
        스택을 생성할 때 조정할 원하는 노드 수를 입력한다.

    * **NodeAutoScalingGroupMaxSize** :  
        Auto Scaling 그룹이 확장할 수 있는 Work node의 최대 노드 수를 입력한다.

    * **NodeInstanceType** :  
        Work node에 대한 인스턴스 유형을 선택한다.

    * **NodeImageId** :  
        리전에 대한 현재 Amazon EKS Work node AMI ID를 입력한다.  
        최신 Amazon EKS 최적화 AMI(GPU 지원 유무는 상이)의 AMI ID는 다음 표에 나와 있다.  

        참조 : <https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html>

        **Kubernetes version 1.12.7**

        | 리전 | Amazon EKS 최적화 AMI | (GPU 지원 포함) |
        |:--|:--|:--|
        |Asia Pacific (Tokyo) (ap-northeast-1)|ami-0bfedee6a7845c26d|ami-08e41cc84f4b3f27f|
        |Asia Pacific (Seoul) (ap-northeast-2)|ami-0a904348b703e620c|ami-0c43b885e33fdc29e|
        |Asia Pacific (Sydney) (ap-southeast-2)|ami-0f0121e9e64ebd3dc|ami-07079cd9ff1b312da|

        **Kubernetes version 1.11**

        | 리전 | Amazon EKS 최적화 AMI | (GPU 지원 포함) |
        |:--|:--|:--|
        |US West (Oregon) (us-west-2)|ami-0a2abab4107669c1b|ami-0c9e5e2d8caa9fb5e|
        |US East (N. Virginia) (us-east-1)|ami-0c24db5df6badc35a|ami-0ff0241c02b279f50|
        |US East (Ohio) (us-east-2)|ami-0c2e8d28b1f854c68|ami-006a12f54eaafc2b1 |
        |EU (Frankfurt) (eu-central-1)|ami-010caa98bae9a09e2|ami-0d6f0554fd4743a9d|
        |EU (Stockholm) (eu-north-1)|ami-06ee67302ab7cf838|ami-0b159b75|
        |EU (Ireland) (eu-west-1)|ami-01e08d22b9439c15a|ami-097978e7acde1fd7c|
        |Asia Pacific (Tokyo) (ap-northeast-1)|ami-0f0e8066383e7a2cb|ami-036b3969c5eb8d3cf|
        |Asia Pacific (Seoul) (ap-northeast-2)|ami-0b7baa90de70f683f|ami-0b7f163f7194396f7|
        |Asia Pacific (Singapore) (ap-southeast-1)|ami-019966ed970c18502|ami-093f742654a955ee6|
        |Asia Pacific (Sydney) (ap-southeast-2)|ami-06ade0abbd8eca425|ami-05e09575123ff498b|

        **Kubernetes version 1.10**

        | 리전 | Amazon EKS 최적화 AMI | (GPU 지원 포함) |
        |:--|:--|:--|
        |US West (Oregon) (us-west-2)|ami-09e1df3bad220af0b|ami-0ebf0561e61a2be02|
        |US East (N. Virginia) (us-east-1)|ami-04358410d28eaab63|ami-0131c0ca222183def|
        |US East (Ohio) (us-east-2)|ami-0b779e8ab57655b4b|ami-0abfb3be33c196cbf |
        |EU (Frankfurt) (eu-central-1)|ami-08eb700778f03ea94|ami-000622b1016d2a5bf|
        |EU (Stockholm) (eu-north-1)|ami-068b8a1efffd30eda|ami-cc149ab2|
        |EU (Ireland) (eu-west-1)|ami-0de10c614955da932|ami-0dafd3a1dc43781f7|
        |Asia Pacific (Tokyo) (ap-northeast-1)|ami-06398bdd37d76571d|ami-0afc9d14b2fe11ad9|
        |Asia Pacific (Seoul) (ap-northeast-2)|ami-08a87e0a7c32fa649|ami-0d75b9ab57bfc8c9a|
        |Asia Pacific (Singapore) (ap-southeast-1)|ami-0ac3510e44b5bf8ef|ami-0ecce0670cb66d17b|
        |Asia Pacific (Sydney) (ap-southeast-2)|ami-0d2c929ace88cfebe|ami-03b048bd9d3861ce9|

    * **KeyName** :  
        시작 이후 SSH를 사용하여 Work node에 연결하는 데 사용할 수 있는 Amazon EC2 SSH 키 페어 이름을 입력한다.  
        Amazon EC2 키 페어가 아직 없는 경우 AWS Management 콘솔에서 새로 생성할 수 있다.  
        자세한 내용은 Linux 인스턴스용 Amazon EC2 사용 설명서의 Amazon EC2 키 페어를 참조.

        **참고 :** 여기에 키 페어를 입력하지 않으면 AWS CloudFormation 스택이 생성되지 않습니다.

    * **BootstrapArguments** :  
        별도의 kubelet 인수와 같이 Work node 부트스트랩 스크립트에 전달할 선택적 인수를 지정한다.  
        자세한 내용은 https://github.com/awslabs/amazon-eks-ami/blob/master/files/bootstrap.sh에서 부트스트랩 스크립트 사용 정보를 참조.

    * **VpcId** :  
        Work node에서 시작해야 하는 VPC의 ID를 입력한다.

    * **Subnets** :  
        Work node에서 시작해야 하는 위 VPC 내 서브넷을 선택한다.

    * 옵션 페이지에서 스택 리소스에 태그를 지정할 수 있다. **[Next]**를 선택한다.

    * 검토 페이지에서 정보를 검토하고, 스택이 IAM 리소스를 생성할 수 있음을 승인한다. **항목을 체크** 한 다음 생성을 선택한다.

    * 스택이 생성된 후 콘솔에서 이를 선택하고 **출력을** 선택한다.

    * 생성된 노드 그룹에 대해 **NodeInstanceRole을** 기록한다. Amazon EKS Work node를 구성할 때 필요.

    ![eks-create-worker-node]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-worker-node.png)
    ![eks-create-worker-node]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/eks-create-worker-node-3.png)

---
### 5-2. Work node가 클러스터에 조인하도록 하려면

* AWS IAM Authenticator 구성 맵을 다운로드, 편집 및 적용한다.

    * ConfigMap 다운로드:

        ```sh
        curl -O https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2019-02-11/aws-auth-cm.yaml
        ```

    * 텍스트 편집기에서 파일을 연다. 인스턴스 역할의 `<ARN(비인스턴스 프로파일)>` 조각을 이전 절차에서 기록한 NodeInstanceRole 값으로 교체하고 파일을 저장한다.

        **중요:**  
        이 파일에서 어떠한 행도 수정하지 마십시오.

        ```yaml
        apiVersion: v1
        kind: ConfigMap
        metadata:
        name: aws-auth
        namespace: kube-system
        data:
        mapRoles: |
            - rolearn: <ARN of instance role (not instance profile)>
            username: system:node:{{EC2PrivateDNSName}}
            groups:
                - system:bootstrappers
                - system:nodes
        ```

    * 구성을 적용한다. 이 명령을 완료하는 데 몇 분이 걸릴 수 있다.

        ```sh
        kubectl apply -f aws-auth-cm.yaml
        ```

* 노드의 상태를 확인하고 Ready 상태가 될 때까지 대기한다.

    ```sh
    kubectl get nodes --watch
    ```
* Kubernetes Metric Server 설치 한다.  
  참조 : <https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html>
  
* Cocktail-addon을 설치 한다.

<br/>
## Amazon Elastic File System 만들기
Amazon Elastic File System (Amazon EFS)은 Amazon EC2에서 사용하기 위한 간단하고 확장 가능한 파일 스토리지를 제공한다.  
참조 : <https://docs.aws.amazon.com/ko_kr/efs/latest/ug/whatisefs.html>

<!--

### Amazon EFS 파일 시스템 만들기

### 1. EC2 리소스 만들기 및 EC2 인스턴스 시작
이 사용 설명서에서는 이미 생성한 인스턴스의 보안 그룹만 할당 한다.
참조 : {1단계: EC2 리소스 만들기 및 EC2 인스턴스 시작}(https://docs.aws.amazon.com/ko_kr/efs/latest/ug/gs-step-one-create-ec2-resources.html)

* 인스턴스 보기를 선택한다.

* 목록에서 생성한 인스턴스 이름을 선택한 다음 작업을 선택한다.

    * 열린 메뉴에서 네트워킹과 보안 그룹 변경을 차례대로 선택한다.

    ![efs-create-security-group-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/efs-create-security-group-1.png)

    * 기본 VPC 보안 그룹이라는 설명이 있는 보안 그룹 옆 확인란을 선택한다.

    ![efs-create-security-group-2]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/efs-create-security-group-2-1.png)

    * 보안 그룹 할당을 선택한다.

    **참고**  

    이 단계에서는 VPC의 기본 보안 그룹을 Amazon EC2 인스턴스에 할당한다.  
    이렇게하면 인스턴스가 Amazon EFS 파일 시스템 마운트 대상이 2 단계 : Amazon EFS 파일 시스템 만들기에서 연결 권한을 부여하는 보안 그룹의 구성원인지 확인할 수 있다.

    기본 인바운드 및 아웃 바운드 규칙을 사용하여 VPC의 기본 보안 그룹을 사용하면 잠재적으로이 인스턴스와이 파일 시스템을 VPC 내에서 잠재적 인 위협에 노출시킬 수 있다.

    * 목록에서 인스턴스를 선택한다.

    * 설명 탭에서 보안 그룹 – 옆에 두 항목이 나열되어 있는지 확인한다. 하나는 기본 VPC 보안 그룹용이고 다른 하나는 인스턴스 시작 시 생성했던 보안 그룹용입니다.

    ![efs-create-security-group-3]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/efs-create-security-group-3.png)

-->

---
### 1. 보안그룹 생성

* EFS 파일 시스템이 사용할 보안 그룹을 생성 한다.

---
### 2. Amazon EFS 파일 시스템 생성

* Amazon EFS 파일 시스템 생성

    * [Amazon EFS 관리 콘솔](https://console.aws.amazon.com/efs/)을 연다. 

    * **Create File System(파일 시스템 생성)**을 선택한다.

    * VPC와 연결된 시큐리티그룹을 선택(NFS 포트가 열려 있어야한다./ port : 2049)

    * 목록에서 탑재 대상을 생성하기 원하는 서브넷을 선택한다.
    
    * IP 주소를 자동으로 선택.

    * **[Next Step]을** 선택한다.

    * 파일 시스템의 이름을 지정하고, 기본 성능 및 처리량 모드로 선택한 범용 및 버스팅 모드를 유지한 후 **다음 단계를** 선택한다.

    * **Create File System(파일 시스템 생성)**을 선택한다.

    * 목록에서 파일 시스템을 선택하고 **File system ID(파일 시스템 ID)**에 대한 값을 기록한다. 다음 단계에 이 값이 필요.

<!--

### 3. Amazon EC2 인스턴스에 연결 및 Amazon EFS 파일 시스템 탑재
Windows(Git Bash) 또는 Linux를 실행 중인 컴퓨터에서 Amazon EC2 인스턴스에 연결할 수 있다. Amazon EC2 인스턴스를 연결하고 Amazon EFS 파일 시스템을 연결하려면 Amazon EFS 파일 시스템의 탑재 대상에 대한 **File system ID(파일 시스템 ID)** 값이 필요

* Amazon EC2 인스턴스에 연결하고 Amazon EFS 파일 시스템을 탑재하려면

    * SSH 클라이언트를 열고 EC2 인스턴스에 연결한다.

        * 다음 명령을 사용하여 사용자만 읽을 수 있도록 프라이빗 키 파일의 권한을 설정한다.

        ```
        chmod 400 /path/my-key-pair.pem
        ```  
        이러한 권한을 설정하지 않으면 이 키 페어를 사용하여 인스턴스에 연결할 수 없습니다.  
        자세한 정보는 [오류: 보호되지 않는 프라이빗 키 파일](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/TroubleshootingInstancesConnecting.html#troubleshoot-unprotected-key) 단원을 참조.


        * ssh 명령을 사용하여 인스턴스에 연결한다.  
        프라이빗 키(.pem) 파일과 user_name@public_dns_name을 지정한다. 예를 들어 Amazon Linux 2 또는 Amazon Linux AMI를 사용한 경우 사용자 이름은 ec2-user입니다.

            다음과 같은 응답이 표시됩니다:

            ```
            The authenticity of host 'ec2-198-51-100-1.compute-1.amazonaws.com (10.254.142.33)'
            can't be established.
            RSA key fingerprint is 1f:51:ae:28:bf:89:e9:d8:1f:25:5d:37:2d:7d:b8:ca:9f:f5:f1:6f.
            Are you sure you want to continue connecting (yes/no)?
            ```

        * yes를 입력한다.

    * Amazon EFS 파일 시스템을 탑재하려면 :  
    **참고 :** 파일 시스템 목록에서 생성 한 파일 시스템을 선택 하면 파일 시스템 액세스에서 해당 파일 시스템의 탑재 지침이 있다.
    
        * 연결 후 Amazon EFS 탑재 헬퍼가 있는 amazon-efs-utils 패키지를 설치한다.

        ```
        sudo yum install -y amazon-efs-utils
        ```

        * 다음 명령으로 탑재 지점에 대한 디렉터리를 만듭니다.

        ```
        sudo mkdir efs
        ```

        * EFS 탑재 헬퍼 사용:

        ```
        sudo mount -t efs fs-b4c21dd5:/ efs
        ```

        * 다음 명령을 사용하여 파일 생성을 확인 한다.

        ```
        $ cd efs
        $ sudo mkdir getting-started
        $ sudo chown ec2-user getting-started
        $ cd getting-started
        $ touch test-file.txt
        $ ls -al
        ```
-->

---
### 4. EFS Persistent Volumes on Kubernetes on AWS  
참조 : [Amazon EFS를 선택해야하는 경우](https://aws.amazon.com/efs/when-to-choose-efs/)

* **Deploy the efs-provisioner**  
**참조 :** <https://github.com/kubernetes-incubator/external-storage/tree/master/aws/efs>  
    efs-provisioner를 사용하면 EFS 저장소를 kubernetes의 PersistentVolume으로 마운트 할 수 있다.  
    AWS EFS 리소스에 액세스 할 수있는 컨테이너로 구성된다.  
    컨테이너는 EFS 파일 시스템 ID, AWS 영역 및 efs-provisioner에 사용할 이름을 포함하는 configmap을 읽는다.

    * 아래 스크립트를 사용 한다.

    * **kubectl apply -f 1-eks-cocktail-efs-rbac.yaml**  
    클러스터에 RBAC가 활성화되어 있거나 OpenShift를 실행중인 경우 공급자에게 권한을 부여해야한다.  
    "default"가 아닌 네임 스페이스 / 프로젝트에 있다면 rbac.yaml을 편집한다. 

    ```
    ---
    # ServiceAccount
    apiVersion: v1
    kind: ServiceAccount
    metadata:
    name: efs-provisioner
    ---
    kind: ClusterRole
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
    name: efs-provisioner-runner
    rules:
    - apiGroups: [""]
        resources: ["persistentvolumes"]
        verbs: ["get", "list", "watch", "create", "delete"]
    - apiGroups: [""]
        resources: ["persistentvolumeclaims"]
        verbs: ["get", "list", "watch", "update"]
    - apiGroups: ["storage.k8s.io"]
        resources: ["storageclasses"]
        verbs: ["get", "list", "watch"]
    - apiGroups: [""]
        resources: ["events"]
        verbs: ["create", "update", "patch"]
    ---
    kind: ClusterRoleBinding
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
    name: run-efs-provisioner
    subjects:
    - kind: ServiceAccount
        name: efs-provisioner
        # replace with namespace where provisioner is deployed
        namespace: default
    roleRef:
    kind: ClusterRole
    name: efs-provisioner-runner
    apiGroup: rbac.authorization.k8s.io
    ---
    kind: Role
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
    name: leader-locking-efs-provisioner
    rules:
    - apiGroups: [""]
        resources: ["endpoints"]
        verbs: ["get", "list", "watch", "create", "update", "patch"]
    ---
    kind: RoleBinding
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
    name: leader-locking-efs-provisioner
    subjects:
    - kind: ServiceAccount
        name: efs-provisioner
        # replace with namespace where provisioner is deployed
        namespace: default
    roleRef:
    kind: Role
    name: leader-locking-efs-provisioner
    apiGroup: rbac.authorization.k8s.io
    ```

    * **kubectl apply -f 2-eks-cocktail-efs-provisioner.yaml**  
    Deployment efs-provisione

    ```
    ---
    apiVersion: v1
    kind: ConfigMap
    metadata:
    name: efs-provisioner
    data:
    # your file.system.id , aws.region
    file.system.id: fs-b4c21dd5
    aws.region: ap-northeast-2
    provisioner.name: acornsoft.io/aws-efs
    dns.name: ""
    ---
    ---
    kind: Deployment
    apiVersion: extensions/v1beta1
    metadata:
    name: efs-provisioner
    spec:
    replicas: 1
    strategy:
        type: Recreate 
    template:
        metadata:
        labels:
            app: efs-provisioner
        spec:
        serviceAccount: efs-provisioner
        containers:
            - name: efs-provisioner
            image: quay.io/external_storage/efs-provisioner:latest
            env:
                - name: FILE_SYSTEM_ID
                valueFrom:
                    configMapKeyRef:
                    name: efs-provisioner
                    key: file.system.id
                - name: AWS_REGION
                valueFrom:
                    configMapKeyRef:
                    name: efs-provisioner
                    key: aws.region
                - name: DNS_NAME
                valueFrom:
                    configMapKeyRef:
                    name: efs-provisioner
                    key: dns.name
                    optional: true
                - name: PROVISIONER_NAME
                valueFrom:
                    configMapKeyRef:
                    name: efs-provisioner
                    key: provisioner.name
            volumeMounts:
                - name: pv-volume
                mountPath: /persistentvolumes
        volumes:
            - name: pv-volume
            nfs:
                # your file-system DNS NAME
                server: fs-b4c21dd5.efs.ap-northeast-2.amazonaws.com
                path: /
    ---
    ```

    * **kubetl apply -f 3-eks-cocktail-efs-storage-class.yaml**  
    Cocktail 퍼시스턴트 볼륨 Storage Class 생성

    ```
    # single-storage : EBS-PV
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
    name: single-storage
    annotations:
        storageclass.beta.kubernetes.io/is-default-class: "false"
    labels:
        acornsoft.io/provisioner-type: AWSEBS
        acornsoft.io/type: SINGLE
        k8s-addon: storage-aws.addons.k8s.io
    provisioner: kubernetes.io/aws-ebs
    reclaimPolicy: Delete
    volumeBindingMode: Immediate
    parameters:
    type: gp2

    ---
    # shared-storage : EFS-PV
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
    name: shared-storage
    annotations:
        storageclass.beta.kubernetes.io/is-default-class: "false"
    labels:
        acornsoft.io/provisioner-type: AWSEFS
        acornsoft.io/type: SHARED
        k8s-addon: storage-aws.addons.k8s.io
    # your provisioner.name   
    provisioner: efs-test-pvc/aws-efs
    ---
    ```

    * **4-eks-cocktail-efs-sample-pvc.yaml**
    샘플 PVC

    ```
    # sample pvc
    kind: PersistentVolumeClaim
    apiVersion: v1
    metadata:
    name: efs-test-pvc
    annotations:
        volume.beta.kubernetes.io/storage-class: "shared-storage"
    spec:
    storageClassName: shared-storage
    accessModes:
        - ReadWriteMany
    resources:
        requests:
        storage: 1Mi
    ---
    ```

    * 아래 명령으로 퍼시스턴트 볼륨을 확인 한다.
    
    ```
    kubectl get pv 
    ```

    ![efs-create-pv-1]({{< param imageRootDir >}}/assets/KR/{{< param version >}}/EKS/efs-create-pv-1.png)  
